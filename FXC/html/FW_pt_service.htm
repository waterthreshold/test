<html>
<head>
<title>W6B-T223-001</title>
<meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
<link href="css/new_custom.css" rel="stylesheet" type="text/css">
<script src="jquery.js"></script>
<script src="script/script.js"></script>
<script src="func.js"></script>
<script src="utility.js"></script>
</head>

<body onload="loadSettings();" class="page-body">
<div class="container-fluid frame-content" id="frame-content">
    <form id="target"  name="formname" action="fwpt_service.cgi" method="POST">
        <input type="hidden" name="buttonHit">
        <input type="hidden" name="buttonValue">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Port Triggering - Services</div>
                    </div>
                    <div class="card-body">
                        <div class="mui-textfield">
                            <input class="form-control" id="pt_name" type="text" name="pt_name" maxlength="30" value="<% fw_cgi_pt_get_policy_param("pt_name"); %>">
                            <label tabindex="-1">Service Name</label>
                        </div>
                        <div class="mui-textfield">
                            <select class="form-control" id="src_ip_type" name="src_ip_type" onChange="setsrc();">
                                <option value=1>Any</option>
                                <option value=2>Single address</option>
                            </select>
                            <label tabindex="-1">Service User</label>
                        </div>
                        <div class="mui-textfield input-ip">
                            <input id="src_ip1" type="text" class="form-control" name="src_ip1" maxlength="3" onkeydown="bscheck(event,this,1)" onkeyup="jumpcheck(this,0)">.
                            <input id="src_ip2" type="text" class="form-control" maxlength="3" name="src_ip2" onkeydown="bscheck(event,this,0)" onkeyup="jumpcheck(this,0)">.
                            <input id="src_ip3" type="text" class="form-control" maxlength="3" name="src_ip3" onkeydown="bscheck(event,this,0)" onkeyup="jumpcheck(this,0)">.
                            <input id="src_ip4" type="text" class="form-control" maxlength="3" name="src_ip4" onkeydown="bscheck(event,this,0)" onkeyup="jumpcheck(this,1)">
                            <label tabindex="-1">Internal IP address</label>
                        </div>
                    </div>
                    <div class="card-divider"></div>
                    <div class="card-body">
                        <div class="mui-textfield">
                            <select class="form-control" id="pt_type" name="pt_type">
                                <option value=6>TCP</option>
                                <option value=17>UDP</option>
                            </select>
                            <label tabindex="-1">Service Type</label>
                        </div>
                        <div class="mui-textfield">
                            <input class="form-control" id="pt_port" type="text" name="pt_port" maxlength="5">
                            <label tabindex="-1">Triggering Port (1~65534)</label>
                        </div>
                    </div>
                    <div class="card-divider"></div>
                    <div class="card-subheader">
                        <div class="card-title">Inbound Connection</div>
                    </div>
                    <div class="card-body">
                        <div class="mui-textfield">
                            <select class="form-control" id="in_port_type" name="in_port_type">
                                <option value=100><%getstr("block_ser_setup_tcp_udp");%></option>
                                <option value=6>TCP</option>
                                <option value=17>UDP</option>
                            </select>
                            <label tabindex="-1">Connection Type</label>
                        </div>
                        <div class="mui-textfield">
                            <input class="form-control" id="in_port_start" type="text" name="in_port_start" maxlength="5">
                            <label tabindex="-1">Starting Port (1~65534)</label>
                        </div>
                        <div class="mui-textfield">
                            <input class="form-control" id="in_port_end" type="text" name="in_port_end" maxlength="5">
                            <label tabindex="-1">Ending Port (1~65534)</label>
                        </div>
                    </div>
                    <div class="card-bottom">
                        <button id="apply" value="Apply"  onclick="buttonClick(this,'Apply');if(!checkData()) return false;" type="submit" name="apply" class="<%gui_get_guest_or_admin_mode("0");%> btn btn-primary pull-right btn-round">Apply</button>
                    </div>
                </div>
            </div>
        </div>

        <input type="hidden" name="src_ip" value="<% fw_cgi_pt_get_policy_param("src_ip");%>">
        <input type="hidden" name="out_port_type" value="0">
    </form>
</div>
</body>

<script>
var df_sel = <% fw_cgi_pt_get_policy_param("df_sel"); %>;
var fwpt_action = <% fw_cgi_pt_get_policy_param("fwpt_action"); %>;

$(document).ready(function()
{
    $("#target").submit(function() {
        buttonFilter();
    });
});

function setsrc()
{
    var cf = document.forms[0];
    var type = cf.src_ip_type.selectedIndex;
    if (type == 1)
    {
        cf.src_ip1.disabled = false;
        cf.src_ip2.disabled = false;
        cf.src_ip3.disabled = false;
        cf.src_ip4.disabled = false;
    }
    else
    {
        cf.src_ip1.disabled = true;
        cf.src_ip2.disabled = true;
        cf.src_ip3.disabled = true;
        cf.src_ip4.disabled = true;
    }
}

function setDisable(disable)
{
    var cf = document.forms[0];
    cf.pt_name.disabled = disable;
    cf.pt_type.disabled = disable;
    cf.pt_port.disabled = disable;
    cf.in_port_type.disabled = disable;
    cf.in_port_start.disabled = disable;
    cf.in_port_end.disabled = disable;
}

function loadSettings()
{
    var cf = document.forms[0];
    var src_ip_type = "<% fw_cgi_pt_get_policy_param("src_ip_type");%>";
    if (src_ip_type == "2")
    {
        var src_ip = cf.src_ip.value.split(".");
        cf.src_ip1.value = src_ip[0];
        cf.src_ip2.value = src_ip[1];
        cf.src_ip3.value = src_ip[2];
        cf.src_ip4.value = src_ip[3];
        cf.src_ip_type.selectedIndex = 1;
    }
    else
    {
        cf.src_ip_type.selectedIndex = 0;
        cf.src_ip1.value = "";
        cf.src_ip2.value = "";
        cf.src_ip3.value = "";
        cf.src_ip4.value = "";
    }
    setsrc();

    var pt_type = "<% fw_cgi_pt_get_policy_param("pt_type");%>";
    if (pt_type == "17")
        cf.pt_type.selectedIndex = 1;
    else
        cf.pt_type.selectedIndex = 0;
    cf.pt_port.value = "<% fw_cgi_pt_get_policy_param("pt_port"); %>";

    var in_port_type = "<% fw_cgi_pt_get_policy_param("in_port_type");%>";
    if (in_port_type == "6")
        cf.in_port_type.selectedIndex = 1;
    else if (in_port_type == "17")
        cf.in_port_type.selectedIndex = 2;
    else
        cf.in_port_type.selectedIndex = 0;
    cf.in_port_start.value = "<% fw_cgi_pt_get_policy_param("in_port_start"); %>";
    cf.in_port_end.value = "<% fw_cgi_pt_get_policy_param("in_port_end"); %>";

    if (df_sel)
        setDisable(true);

    parent.hide_loading();
}

function checkPort(name, port)
{
    var msg = "";
    var portNum = port;

    if (port.length == 0)
        msg = name + " must not be blank.n";
    if (isNaN(portNum) || portNum < 1 || portNum > 65534 || !_isNumeric(portNum))
        msg = "Invalid" + name + ", must be in the range 1-65534.n";
    return msg;
}

function checkData()
{
    var cf = document.forms[0];
    var msg = "";

    if (cf.pt_name.value.length == 0)
        msg += "Service name cannot be null.";

    if(cf.pt_name.value==""||cf.pt_name.value.match( /[^\x20-\x7E]/ ))
    {
        alert("Invalid service name.");
        cf.pt_name.focus();
        return false;
    }

    if (cf.src_ip_type.selectedIndex == 1)
    {
        if(checkIP(cf.src_ip1,cf.src_ip2,cf.src_ip3,cf.src_ip4,254)||(parseInt(cf.src_ip4.value,10)==0))
            msg+= "Invalid IP address. Please enter it again.";
        else
        {
            cf.src_ip1.value = parseInt(cf.src_ip1.value,10);
            cf.src_ip2.value = parseInt(cf.src_ip2.value,10);
            cf.src_ip3.value = parseInt(cf.src_ip3.value,10);
            cf.src_ip4.value = parseInt(cf.src_ip4.value,10);
        }
    }

    msg += checkPort("Triggering Port", cf.pt_port.value);

    msg += checkPort("Inbound connection start port", cf.in_port_start.value);

    if (cf.in_port_end.value.length > 0)
    {
        msg += checkPort("Inbound connection end port", cf.in_port_end.value);
        if (parseInt(cf.in_port_end.value,10) < parseInt(cf.in_port_start.value,10))
            msg += "Invalid inbound connection port range.n";
    }

    if (msg.length > 0)
    {
        alert(msg);
        return false;
    }
    
    cf.src_ip.value = cf.src_ip1.value+'.'+cf.src_ip2.value+'.'+cf.src_ip3.value+'.'+cf.src_ip4.value;
    cf.in_port_start.value = parseInt(cf.in_port_start.value,10);
    if (cf.in_port_end.value.length == 0)
        cf.in_port_end.value = cf.in_port_start.value;
    else
        cf.in_port_end.value = parseInt(cf.in_port_end.value,10);

    setDisable(false);

    parent.show_loading();

    return true;
}
</script>
</html>
